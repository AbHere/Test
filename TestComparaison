public async Task<List<SettlementRecordComparison>> ProcessSSI(DateTime startDate, DateTime endDate)
{
    var auditTiers = await _dBContext.GetRecentAuditTiers(startDate, endDate);
    var allComparisons = new List<SettlementRecordComparison>();

    foreach (var auditTier in auditTiers)
    {
        var settlementResults = await _dBContext.GetSettlementResults(
            auditTier.AuditTierSequence,
            auditTier.PreviousAuditTierSequence);

        var comparisons = _settlementComparisonService.CompareRecords(settlementResults.ToList(), auditTier);
        allComparisons.AddRange(comparisons);
    }

    return allComparisons;
}


using System.Globalization;

private static DateTime? ParseDate(string? value)
{
    if (string.IsNullOrWhiteSpace(value))
        return null;

    // adapte le format si besoin (culture FR, etc.)
    if (DateTime.TryParse(value, CultureInfo.InvariantCulture,
                          DateTimeStyles.None, out var dt))
    {
        return dt;
    }

    return null;
}

private static IEnumerable<SettlementRecord> SimplifyRecords(IEnumerable<SettlementRecord> records)
{
    // But : pour chaque (NewSequence, OldSequence, IdSequence)
    // on garde UNE seule ligne : la plus "rÃ©cente"
    // (StartValidity la plus rÃ©cente, puis Validation_Date la plus rÃ©cente)

    return records
        .GroupBy(r => new
        {
            r.NewSequence,
            r.OldSequence,
            r.IdSequence
        })
        .Select(g =>
        {
            return g
                .OrderByDescending(r => ParseDate(r.StartValidity) ?? DateTime.MinValue)
                .ThenByDescending(r => ParseDate(r.Validation_Date) ?? DateTime.MinValue)
                .First();
        });
}


public async Task<List<SettlementRecordComparison>> ProcessSSI(DateTime startDate, DateTime endDate)
{
    var auditTiers = await _dBContext.GetRecentAuditTiers(startDate, endDate);
    var allComparisons = new List<SettlementRecordComparison>();

    foreach (var auditTier in auditTiers)
    {
        var settlementResults = await _dBContext.GetSettlementResults(
            auditTier.AuditTierSequence,
            auditTier.PreviousAuditTierSequence);

        // ðŸ”½ Ã©tape de nettoyage
        var simplifiedResults = SimplifyRecords(settlementResults).ToList();

        var comparisons = _settlementComparisonService.CompareRecords(simplifiedResults, auditTier);
        allComparisons.AddRange(comparisons);
    }

    return allComparisons;
}



