WITH ChangeInfo AS (
    SELECT
        x.code,
        x.sequence,
        x.changer_name,
        x.change_date
    FROM (
        SELECT
            ats.code,
            ats.sequence,
            ru.name       AS changer_name,
            atc.datemodif AS change_date,
            ROW_NUMBER() OVER (
                PARTITION BY ats.code, ats.sequence
                ORDER BY atc.datemodif DESC
            ) AS rn
        FROM (
            SELECT
                code,
                sequence,
                numero,
                TRUNC(start_validity) AS start_validity,
                LAG(TRUNC(start_validity)) OVER (
                    PARTITION BY code
                    ORDER BY numero
                ) AS prev_start
            FROM audit_tierssettlement
            -- ici on travaille bien par SEQUENCE d'audit
            WHERE sequence IN (:AuditTierSequence, :PreviousAuditTierSequence)
        ) ats
        JOIN AUDIT_TIERS_COMPO atc
          ON atc.sequence = ats.sequence
        LEFT JOIN riskusers ru
          ON ru.ident = atc.id
        WHERE ats.prev_start   = DATE '2099-12-31'
          AND ats.start_validity < DATE '2099-12-31'
    ) x
    WHERE x.rn = 1
),
SettlementResults AS (
    SELECT 
        ats.ID,
        ats.ACCOUNT_ROUTER,
        DECODE(ats.ACCOUNT_TYPE,1,'Both',2,'Cash',3,'Instrument',ats.ACCOUNT_TYPE) ACCOUNT_TYPE,
        ats.AGENT_ID,
        DECODE(ats.ALLOTMENT, -1, '*', A.LIBELLE) ALLOTMENT,
        ats.BANKID,
        DECODE(ats.BANKID,-1,'*', (SELECT name FROM tiers WHERE ident IN(ats.BANKID)) ) AS Financial_Institution,
        ats.BANKNUM,
        ats.BENEFICIAIRE,
        ats.BO_TREASURY_ACCOUNT_ID,
        DECODE(ats.BUSINESS_EVENT, -1, '*') BUSINESS_EVENT,
        ats.CARVE_OUT,
        ats.CODE,
        ats.COMMENTAIRE1,
        ats.CONDITION,
        ats.CONDITION2,
        ats.CONDITION3,
        ats.CONTACTNAME,
        ats.COUNTRYCODE,
        DECODE(ats.CURRENCY, -1, '*', DEVISE_TO_STR(ats.CURRENCY)) CURRENCY,
        ats.CUSTODIAN_ID,
        DECODE(ats.DELIVERY_TYPE, -1, '*', 1, 'DVP', 2, 'FOP', 3, 'N/A') DELIVERY_TYPE,
        DECODE(ats.DEPOSITARY, -1, '*', DP.NAME) DEPOSITARY,
        ats.END_VALIDITY,
        ats.IBKACCOUNT,
        ats.INFO1,
        ats.INFO2,
        ats.INFO3,
        ats.INFO4,
        ats.INFO5,
        ats.INFO6,
        ats.INITIAL_DEPOSITORY,
        ats.LOSTRO1_CODE,
        ats.LOSTRO1_CODETYPE,
        DECODE(ats.MARKET, -1,'*', NUM_TO_STR(ats.MARKET) || ' - '
               || (SELECT libelle FROM marche WHERE mnemomarche IN (ats.MARKET))) AS MARKET,
        ats.PAYMENT,
        DECODE(ats.PAYMENT, -1, '*', PM.LIBELLE) PAYMENTMETHOD,
        PS.NAME AS PLACE_OF_SETTLEMENT,
        ats.ROUTING,
        ats.SEQUENCE          AS AUDIT_SEQUENCE,  -- important
        DECODE(ats.SIGN,1,'(+)',2,'(0)',3,'(-)','(*)') AS Sign,
        ats.SSI_PATH_ID,
        ats.START_VALIDITY,
        DECODE(ats.TYPE,1,'*',2,'Counterparty',3,'Broker',4,'Depositary',5,'Entity',6,'Counterparty 2',ats.TYPE) AS TYPE,
        DECODE(ats.UNDERLYING_ALLOTMENT , -1,'*',
               (SELECT libelle FROM affectation WHERE ident = ats.UNDERLYING_ALLOTMENT )) AS UNDERLYING_ALLOTMENT,
        DECODE(ats.UNDERLYING_CURRENCY, -1, '*', DEVISE_TO_STR(ats.UNDERLYING_CURRENCY)) AS UNDERLYING_CURRENCY,
        DECODE(ats.UNDERLYING_MARKET, -1,'*', NUM_TO_STR(ats.UNDERLYING_MARKET) || ' - '
               || (SELECT libelle FROM marche WHERE mnemomarche IN (ats.UNDERLYING_MARKET))) AS UNDERLYING_MARKET,
        DECODE(ats.WORKFLOW_ID, -1, 'N/A', BCW.NAME) SETTLEMENT_METHOD,
        ats.CODE              AS SOURCE_SEQUENCE,  -- ce qui sera NewSequence / OldSequence
        tr.ident              AS THIRD_SOPHIS_ID,
        tr.reference          AS THIRD_REFERENCE,
        tr.EXTERNREF          AS External_Reference,
        tr.location           AS ThirdParty_Location,
        tr.domicile           AS ThirdParty_Domicile,
        TRIM(COALESCE(tg.ADDRESS1, '') || ' ' ||
             COALESCE(tg.ADDRESS2, '') || ' ' ||
             COALESCE(tg.ADDRESS3, '') || ' ' ||
             COALESCE(tg.ADDRESS4, '') || ' ' ||
             COALESCE(tg.ADDRESS5, '')) AS Full_Address,
        tg.swift              AS SWIFT_CODE,
        tg.fax                AS FAX_NUMBER,
        tg.email              AS EMAIL,
        tr.NAME               AS TIERName,
        bsp.account_name,
        rsk.name              AS USER_NAME,
        ci.changer_name       AS Validator,
        ci.change_date        AS Validation_Date,
        'SOPHIS'              AS CODE_REMETTANT
    FROM AUDIT_TIERSSETTLEMENT ats
    -- ici on corrige la jointure : SEQUENCE <-> SEQUENCE
    LEFT JOIN AUDIT_TIERS_COMPO atc ON ats.SEQUENCE = atc.SEQUENCE
    LEFT JOIN BO_CASH_WORKFLOW BCW   ON BCW.ID = ats.WORKFLOW_ID
    LEFT JOIN TIERS tr               ON tr.ident = atc.code
    LEFT JOIN TIERS DP               ON DP.IDENT = ats.DEPOSITARY
    LEFT JOIN TIERS PS               ON PS.IDENT = ats.PLACE_OF_SETTLEMENT
    LEFT JOIN TIERSGENERAL tg        ON tg.CODE = tr.ident
    LEFT JOIN AFFECTATION A          ON A.IDENT = ats.ALLOTMENT
    LEFT JOIN PAYMENTMETHOD PM       ON PM.IDENT = ats.PAYMENT
    LEFT JOIN RISKUSERS rsk          ON rsk.ident = atc.ID
    LEFT JOIN BO_SSI_PATH bsp        ON bsp.ssi_path_id = ats.ssi_path_id
    LEFT JOIN ChangeInfo ci
           ON ci.code     = ats.code
          AND ci.sequence = ats.sequence
    -- IMPORTANT : on filtre par SEQUENCE d'audit, pas par CODE
    WHERE ats.SEQUENCE IN (:AuditTierSequence, :PreviousAuditTierSequence)
),
NewResults AS (
    SELECT * FROM SettlementResults
    WHERE AUDIT_SEQUENCE = :AuditTierSequence
),
OldResults AS (
    SELECT * FROM SettlementResults
    WHERE AUDIT_SEQUENCE = :PreviousAuditTierSequence
)
SELECT 
    NewResults.SOURCE_SEQUENCE                                       AS NewSequence,
    OldResults.SOURCE_SEQUENCE                                       AS OldSequence,
    COALESCE(NewResults.ID, OldResults.ID)                           AS ID_SEQUENCE1,
    COALESCE(NewResults.TIERName, OldResults.TIERName)               AS TierName,
    COALESCE(NewResults.ACCOUNT_ROUTER, OldResults.ACCOUNT_ROUTER)   AS ACCOUNT_ROUTER_1,
    COALESCE(NewResults.ACCOUNT_TYPE, OldResults.ACCOUNT_TYPE)       AS ACCOUNT_TYPE_1,
    COALESCE(NewResults.AGENT_ID, OldResults.AGENT_ID)               AS AGENT_ID_1,
    COALESCE(NewResults.ALLOTMENT, OldResults.ALLOTMENT)             AS ALLOTMENT_1,
    COALESCE(NewResults.BANKID, OldResults.BANKID)                   AS BANKID_1,
    COALESCE(NewResults.Financial_Institution, OldResults.Financial_Institution) AS Financial_Institution,
    COALESCE(NewResults.BANKNUM, OldResults.BANKNUM)                 AS BANKNUM_1,
    COALESCE(NewResults.BENEFICIAIRE, OldResults.BENEFICIAIRE)       AS BENEFICIAIRE_1,
    COALESCE(NewResults.BO_TREASURY_ACCOUNT_ID, OldResults.BO_TREASURY_ACCOUNT_ID) AS BO_TREASURY_ACCOUNT_ID_1,
    COALESCE(NewResults.BUSINESS_EVENT, OldResults.BUSINESS_EVENT)   AS BUSINESS_EVENT_1,
    COALESCE(NewResults.CARVE_OUT, OldResults.CARVE_OUT)             AS CARVE_OUT_1,
    COALESCE(NewResults.COMMENTAIRE1, OldResults.COMMENTAIRE1)       AS COMMENTAIRE1_1,
    COALESCE(NewResults.CONDITION, OldResults.CONDITION)             AS CONDITION_1,
    COALESCE(NewResults.CONDITION2, OldResults.CONDITION2)           AS CONDITION2_1,
    COALESCE(NewResults.CONDITION3, OldResults.CONDITION3)           AS CONDITION3_1,
    COALESCE(NewResults.CONTACTNAME, OldResults.CONTACTNAME)         AS CONTACTNAME_1,
    COALESCE(NewResults.COUNTRYCODE, OldResults.COUNTRYCODE)         AS COUNTRYCODE_1,
    COALESCE(NewResults.CURRENCY, OldResults.CURRENCY)               AS CURRENCY_1,
    COALESCE(NewResults.CUSTODIAN_ID, OldResults.CUSTODIAN_ID)       AS CUSTODIAN_ID_1,
    COALESCE(NewResults.DELIVERY_TYPE, OldResults.DELIVERY_TYPE)     AS DELIVERY_TYPE_1,
    COALESCE(NewResults.DEPOSITARY, OldResults.DEPOSITARY)           AS DEPOSITARY_1,
    COALESCE(NewResults.END_VALIDITY, OldResults.END_VALIDITY)       AS END_VALIDITY_1,
    COALESCE(NewResults.IBKACCOUNT, OldResults.IBKACCOUNT)           AS IBKACCOUNT_1,
    COALESCE(NewResults.INFO1, OldResults.INFO1)                     AS INFO1_1,
    COALESCE(NewResults.INFO2, OldResults.INFO2)                     AS INFO2_1,
    COALESCE(NewResults.INFO3, OldResults.INFO3)                     AS INFO3_1,
    COALESCE(NewResults.INFO4, OldResults.INFO4)                     AS INFO4_1,
    COALESCE(NewResults.INFO5, OldResults.INFO5)                     AS INFO5_1,
    COALESCE(NewResults.INFO6, OldResults.INFO6)                     AS INFO6_1,
    COALESCE(NewResults.INITIAL_DEPOSITORY, OldResults.INITIAL_DEPOSITORY) AS INITIAL_DEPOSITORY_1,
    COALESCE(NewResults.LOSTRO1_CODE, OldResults.LOSTRO1_CODE)       AS LOSTRO1_CODE_1,
    COALESCE(NewResults.LOSTRO1_CODETYPE, OldResults.LOSTRO1_CODETYPE) AS LOSTRO1_CODETYPE_1,
    COALESCE(NewResults.MARKET, OldResults.MARKET)                   AS MARKET_1,
    COALESCE(NewResults.PAYMENT, OldResults.PAYMENT)                 AS PAYMENT_1,
    COALESCE(NewResults.PAYMENTMETHOD, OldResults.PAYMENTMETHOD)     AS PAYMENTMETHOD,
    COALESCE(NewResults.PLACE_OF_SETTLEMENT, OldResults.PLACE_OF_SETTLEMENT) AS PLACE_OF_SETTLEMENT_1,
    COALESCE(NewResults.ROUTING, OldResults.ROUTING)                 AS ROUTING_1,
    COALESCE(NewResults.AUDIT_SEQUENCE, OldResults.AUDIT_SEQUENCE)   AS SEQUENCE_1,
    COALESCE(NewResults.SIGN, OldResults.SIGN)                       AS SIGN_1,
    COALESCE(NewResults.SSI_PATH_ID, OldResults.SSI_PATH_ID)         AS SSI_PATH_ID_1,
    COALESCE(NewResults.START_VALIDITY, OldResults.START_VALIDITY)   AS START_VALIDITY_1,
    COALESCE(NewResults.TYPE, OldResults.TYPE)                       AS TYPE_1,
    COALESCE(NewResults.UNDERLYING_ALLOTMENT, OldResults.UNDERLYING_ALLOTMENT) AS UNDERLYING_ALLOTMENT_1,
    COALESCE(NewResults.UNDERLYING_CURRENCY, OldResults.UNDERLYING_CURRENCY)   AS UNDERLYING_CURRENCY_1,
    COALESCE(NewResults.UNDERLYING_MARKET, OldResults.UNDERLYING_MARKET)       AS UNDERLYING_MARKET_1,
    COALESCE(NewResults.SETTLEMENT_METHOD, OldResults.SETTLEMENT_METHOD)       AS SETTLEMENT_METHOD_1,
    COALESCE(NewResults.THIRD_SOPHIS_ID, OldResults.THIRD_SOPHIS_ID)           AS THIRD_SOPHIS_ID,
    COALESCE(NewResults.THIRD_REFERENCE, OldResults.THIRD_REFERENCE)           AS THIRD_REFERENCE,
    COALESCE(NewResults.External_Reference, OldResults.External_Reference)     AS External_Reference,
    COALESCE(NewResults.ThirdParty_Location, OldResults.ThirdParty_Location)   AS ThirdParty_Location,
    COALESCE(NewResults.ThirdParty_Domicile, OldResults.ThirdParty_Domicile)   AS ThirdParty_Domicile,
    COALESCE(NewResults.Full_Address, OldResults.Full_Address)                 AS Full_Address,
    COALESCE(NewResults.SWIFT_CODE, OldResults.SWIFT_CODE)                     AS SWIFT_CODE,
    COALESCE(NewResults.FAX_NUMBER, OldResults.FAX_NUMBER)                     AS FAX_NUMBER,
    COALESCE(NewResults.EMAIL, OldResults.EMAIL)                               AS EMAIL,
    COALESCE(NewResults.account_name, OldResults.account_name)                 AS Account_name,
    COALESCE(NewResults.USER_NAME, OldResults.USER_NAME)                       AS USER_NAME,
    COALESCE(NewResults.Validator, OldResults.Validator)                       AS Validator,
    COALESCE(NewResults.Validation_Date, OldResults.Validation_Date)           AS Validation_Date,
    COALESCE(NewResults.CODE_REMETTANT, OldResults.CODE_REMETTANT)             AS CODE_REMETTANT
FROM 
    NewResults
FULL OUTER JOIN 
    OldResults
      ON NewResults.ID = OldResults.ID
WHERE 
      NewResults.ID IS NULL 
   OR OldResults.ID IS NULL
   OR NewResults.ACCOUNT_ROUTER      <> OldResults.ACCOUNT_ROUTER
   OR NewResults.ACCOUNT_TYPE        <> OldResults.ACCOUNT_TYPE
   OR NewResults.AGENT_ID            <> OldResults.AGENT_ID
   OR NewResults.ALLOTMENT           <> OldResults.ALLOTMENT
   OR NewResults.BANKID              <> OldResults.BANKID
   OR NewResults.BANKNUM             <> OldResults.BANKNUM
   OR NewResults.BENEFICIAIRE        <> OldResults.BENEFICIAIRE
   OR NewResults.BO_TREASURY_ACCOUNT_ID <> OldResults.BO_TREASURY_ACCOUNT_ID
   OR NewResults.BUSINESS_EVENT      <> OldResults.BUSINESS_EVENT
   OR NewResults.CARVE_OUT           <> OldResults.CARVE_OUT
   OR NewResults.COMMENTAIRE1        <> OldResults.COMMENTAIRE1
   OR NewResults.CONDITION           <> OldResults.CONDITION
   OR NewResults.CONDITION2          <> OldResults.CONDITION2
   OR NewResults.CONDITION3          <> OldResults.CONDITION3
   OR NewResults.CONTACTNAME         <> OldResults.CONTACTNAME
   OR NewResults.COUNTRYCODE         <> OldResults.COUNTRYCODE
   OR NewResults.CURRENCY            <> OldResults.CURRENCY
   OR NewResults.CUSTODIAN_ID        <> OldResults.CUSTODIAN_ID
   OR NewResults.DELIVERY_TYPE       <> OldResults.DELIVERY_TYPE
   OR NewResults.DEPOSITARY          <> OldResults.DEPOSITARY
   OR NewResults.END_VALIDITY        <> OldResults.END_VALIDITY
   OR NewResults.IBKACCOUNT          <> OldResults.IBKACCOUNT
   OR NewResults.INFO1               <> OldResults.INFO1
   OR NewResults.INFO2               <> OldResults.INFO2
   OR NewResults.INFO3               <> OldResults.INFO3
   OR NewResults.INFO4               <> OldResults.INFO4
   OR NewResults.INFO5               <> OldResults.INFO5
   OR NewResults.INFO6               <> OldResults.INFO6
   OR NewResults.INITIAL_DEPOSITORY  <> OldResults.INITIAL_DEPOSITORY
   OR NewResults.LOSTRO1_CODE        <> OldResults.LOSTRO1_CODE
   OR NewResults.LOSTRO1_CODETYPE    <> OldResults.LOSTRO1_CODETYPE
   OR NewResults.MARKET              <> OldResults.MARKET
   OR NewResults.PAYMENT             <> OldResults.PAYMENT
   OR NewResults.PLACE_OF_SETTLEMENT <> OldResults.PLACE_OF_SETTLEMENT
   OR NewResults.ROUTING             <> OldResults.ROUTING
   OR NewResults.AUDIT_SEQUENCE      <> OldResults.AUDIT_SEQUENCE
   OR NewResults.SIGN                <> OldResults.SIGN
   OR NewResults.SSI_PATH_ID         <> OldResults.SSI_PATH_ID
   OR NewResults.START_VALIDITY      <> OldResults.START_VALIDITY
   OR NewResults.TYPE                <> OldResults.TYPE
   OR NewResults.External_Reference  <> OldResults.External_Reference
   OR NewResults.ThirdParty_Location <> OldResults.ThirdParty_Location
   OR NewResults.ThirdParty_Domicile <> OldResults.ThirdParty_Domicile
   OR NewResults.Full_Address        <> OldResults.Full_Address
   OR NewResults.SWIFT_CODE          <> OldResults.SWIFT_CODE
   OR NewResults.FAX_NUMBER          <> OldResults.FAX_NUMBER
   OR NewResults.EMAIL               <> OldResults.EMAIL
   OR NewResults.UNDERLYING_ALLOTMENT <> OldResults.UNDERLYING_ALLOTMENT
   OR NewResults.UNDERLYING_CURRENCY <> OldResults.UNDERLYING_CURRENCY
   OR NewResults.UNDERLYING_MARKET   <> OldResults.UNDERLYING_MARKET
   OR NewResults.SETTLEMENT_METHOD   <> OldResults.SETTLEMENT_METHOD;
